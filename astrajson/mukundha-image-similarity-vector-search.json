{
    "key": "mukundha-image-similarity-vector-search",
    "tags": [
        "vector",
        "cassio",
        "langchain"
    ],
    "urls": {
        "github": "https://github.com/mukundha/image-similarity-vector-search",
        "heroimage": "https://raw.githubusercontent.com/datastaxdevs/gallery_content_loader/main/datastax-logo_square.png"
    },
    "last_modified": "Sat, 02 Sep 2023 07:34:41 GMT",
    "forks_count": 1,
    "stargazers_count": 1,
    "name": "Image Similarity with Vector Search",
    "description": "Demonstrate Datastax Astra's Vector search with Image similarity search using Amazon Berkeley Objects (ABO) Dataset.",
    "duration": "20m",
    "skilllevel": "Intermediate",
    "priority": 1,
    "readme": "<h1>Image Similarity with Vector Search</h1>\n<p>Demonstrate Datastax <a href=\"https://docs.datastax.com/en/astra-serverless/docs/vector-search/overview.html\">Astra's</a> Vector search with Image similarity search using Amazon Berkeley Objects (ABO) Dataset</p>\n<h2>Demo</h2>\n<p><a href=\"https://github.com/mukundha/image-similarity-vector-search/assets/1277515/c543887d-ea5e-472a-ac0d-1e0009e24586\">https://github.com/mukundha/image-similarity-vector-search/assets/1277515/c543887d-ea5e-472a-ac0d-1e0009e24586</a></p>\n<p>Click <a href=\"https://mukundha.web.app/\">here</a> for a live demo. Try it on your mobile.</p>\n<hr />\n<p>Follow along to setup this demo yourself and learn how to do image similarity with Vector search</p>\n<p>This repository includes 3 sections</p>\n<ol>\n<li>Data processing</li>\n</ol>\n<ul>\n<li>Generate Vector embeddings for Images</li>\n<li>Load Vector embeddings into Astra</li>\n</ul>\n<ol start=\"2\">\n<li>API - Similarity search</li>\n</ol>\n<ul>\n<li>Exposes an API to perform Vector search and retrieve similar images</li>\n</ul>\n<ol start=\"3\">\n<li>UI App</li>\n</ol>\n<ul>\n<li>Allows users to capture images and search for similar images</li>\n</ul>\n<h2>1. Data processing</h2>\n<p>Refer to <a href=\"#citation\">Citation</a> for how to download and get access to this dataset.</p>\n<p>Dataset includes <code>147,702</code> products and <code>398,212</code> unique catalog images</p>\n<p>Code is in <code>data-processing</code> folder.</p>\n<h4>Initialize DB</h4>\n<p>Review the Astra <a href=\"https://docs.datastax.com/en/astra-serverless/docs/getting-started/getting-started.html\">Getting started</a> guide, if needed.</p>\n<p>Create the products table with Vector&lt;&gt; column to represent main_image_id of the product and SAI index for the Vector column.</p>\n<pre><code>CREATE TABLE amazon_products (\n    brand TEXT,\n    bullet_point TEXT,\n    color TEXT,\n    item_id TEXT,\n    item_name TEXT,\n    item_weight TEXT,\n    model_name TEXT,\n    model_number TEXT,\n    product_type TEXT,\n    main_image_id TEXT,\n    other_image_id TEXT,\n    item_keywords TEXT,\n    country TEXT,\n    marketplace TEXT,\n    domain_name TEXT,\n    node TEXT,\n    material TEXT,\n    style TEXT,\n    item_dimensions TEXT,\n    fabric_type TEXT,\n    product_description TEXT,\n    color_code TEXT,\n    finish_type TEXT,\n    item_shape TEXT,\n    pattern TEXT,\n    spin_id TEXT,\n    model_year TEXT,\n    &quot;3dmodel_id&quot; TEXT,\n    item_name_language TEXT,\n    brand_language TEXT,\n    image_embedding Vector&lt;FLOAT,2048&gt;,\n    PRIMARY KEY (item_id,domain_name)\n);\n\nCREATE CUSTOM INDEX IF NOT EXISTS image_embedding_index ON demo.amazon_products (image_embedding) USING 'org.apache.cassandra.index.sai.StorageAttachedIndex'\n</code></pre>\n<h4>Generate Vector embedding and Load data</h4>\n<p>You should download <code>abo-listings.tar</code> and <code>abo-images-small.tar</code> to your workstation, untar it.</p>\n<pre><code>tar -xvf abo-listings.tar\ngunzip abo-listings/listings/metadata/listings_*.gz\n</code></pre>\n<pre><code>import pandas as pd\nimport glob\n\njson_files = &quot;abo-listings/listings/metadata/listings_*.json&quot;\n\ndfs = []\n\nfor file in glob.glob(json_files):\n    df = pd.read_json(file, lines=True)\n    dfs.append(df)\n\nmerged_df = pd.concat(dfs)\noutput_file = &quot;items.csv&quot;\nmerged_df.to_csv(output_file, index=False)\n</code></pre>\n<p>Setup your environment</p>\n<p>Refer <a href=\"https://docs.datastax.com/en/astra-serverless/docs/getting-started/gs-drivers.html#_connect_to_your_astra_db_cluster\">here</a>, if you need help getting Astra credentials</p>\n<pre><code>export ITEMS_PATH=&lt;path to items.csv generated in prev step&gt;\nexport IMAGE_METADATA_FILE=&quot;&lt;path&gt;/abo-images-small/images/metadata/images.csv&quot;\nexport IMAGES_FOLDER=&quot;&lt;path&gt;/abo-images-small/images/small&quot;\n\nexport ASTRA_USER='ASTRA_CLIENTID'\nexport ASTRA_PASSWORD='ASTRA_CLIENTSECRET'\nexport SECURE_CONNECT_BUNDLE='SCB ZIP FILE PATH'\nexport KEYSPACE='KEYSPACE'\nexport TABLE_NAME='TABLE_NAME'\n</code></pre>\n<hr />\n<p>This code uses <a href=\"https://tfhub.dev/google/imagenet/inception_v3/feature_vector/5\">Inception model</a> to get feature vector for Images.</p>\n<p>Vector size: 2048</p>\n<hr />\n<pre><code>python3 process.py\n</code></pre>\n<hr />\n<p>[Optional] This might run long, depending on your machine and network speed, it needs to load &gt;100k images. You might want to parallelize this or split the items.csv to smaller chunks and run from multiple machines. Optimizing this is a exercise to the reader</p>\n<p>It took me about an hour to load all image embeddings, with 3 nodes.</p>\n<hr />\n<h2>Similarity Search API</h2>\n<p>API Spec</p>\n<p>Request</p>\n<pre><code>POST /upload\nContent-type: application/json\n\n{&quot;photoData&quot;:&quot;data:image/jpeg;base64,xxxxx...&quot;}\n</code></pre>\n<p>Response: Similar Images</p>\n<pre><code>[\n    {\n        &quot;image_id&quot;: &quot;https://storage.googleapis.com/demo-product-images/35/35952a54.jpg&quot;,\n        &quot;item_id&qu",
    "readme_markdown": "# Image Similarity with Vector Search\n\nDemonstrate Datastax [Astra's](https://docs.datastax.com/en/astra-serverless/docs/vector-search/overview.html) Vector search with Image similarity search using Amazon Berkeley Objects (ABO) Dataset\n\n## Demo\n\nhttps://github.com/mukundha/image-similarity-vector-search/assets/1277515/c543887d-ea5e-472a-ac0d-1e0009e24586\n\n\nClick [here](https://mukundha.web.app/) for a live demo. Try it on your mobile.\n\n--- \n\nFollow along to setup this demo yourself and learn how to do image similarity with Vector search\n\nThis repository includes 3 sections \n\n1. Data processing\n- Generate Vector embeddings for Images\n- Load Vector embeddings into Astra\n2. API - Similarity search \n- Exposes an API to perform Vector search and retrieve similar images\n3. UI App\n- Allows users to capture images and search for similar images\n\n## 1. Data processing\n\nRefer to [Citation](#citation) for how to download and get access to this dataset.\n\nDataset includes `147,702` products and `398,212` unique catalog images\n\nCode is in `data-processing` folder.\n\n#### Initialize DB\n\nReview the Astra [Getting started](https://docs.datastax.com/en/astra-serverless/docs/getting-started/getting-started.html) guide, if needed.\n\nCreate the products table with Vector<> column to represent main_image_id of the product and SAI index for the Vector column. \n\n```\nCREATE TABLE amazon_products (\n    brand TEXT,\n    bullet_point TEXT,\n    color TEXT,\n    item_id TEXT,\n    item_name TEXT,\n    item_weight TEXT,\n    model_name TEXT,\n    model_number TEXT,\n    product_type TEXT,\n    main_image_id TEXT,\n    other_image_id TEXT,\n    item_keywords TEXT,\n    country TEXT,\n    marketplace TEXT,\n    domain_name TEXT,\n    node TEXT,\n    material TEXT,\n    style TEXT,\n    item_dimensions TEXT,\n    fabric_type TEXT,\n    product_description TEXT,\n    color_code TEXT,\n    finish_type TEXT,\n    item_shape TEXT,\n    pattern TEXT,\n    spin_id TEXT,\n    model_year TEXT,\n    \"3dmodel_id\" TEXT,\n    item_name_language TEXT,\n    brand_language TEXT,\n    image_embedding Vector<FLOAT,2048>,\n    PRIMARY KEY (item_id,domain_name)\n);\n\nCREATE CUSTOM INDEX IF NOT EXISTS image_embedding_index ON demo.amazon_products (image_embedding) USING 'org.apache.cassandra.index.sai.StorageAttachedIndex'\n```\n\n#### Generate Vector embedding and Load data\n\n\nYou should download `abo-listings.tar` and `abo-images-small.tar` to your workstation, untar it.\n\n```\ntar -xvf abo-listings.tar\ngunzip abo-listings/listings/metadata/listings_*.gz\n```\n```\nimport pandas as pd\nimport glob\n\njson_files = \"abo-listings/listings/metadata/listings_*.json\"\n\ndfs = []\n\nfor file in glob.glob(json_files):\n    df = pd.read_json(file, lines=True)\n    dfs.append(df)\n\nmerged_df = pd.concat(dfs)\noutput_file = \"items.csv\"\nmerged_df.to_csv(output_file, index=False)\n```\n\nSetup your environment\n\nRefer [here](https://docs.datastax.com/en/astra-serverless/docs/getting-started/gs-drivers.html#_connect_to_your_astra_db_cluster), if you need help getting Astra credentials\n\n```\nexport ITEMS_PATH=<path to items.csv generated in prev step>\nexport IMAGE_METADATA_FILE=\"<path>/abo-images-small/images/metadata/images.csv\"\nexport IMAGES_FOLDER=\"<path>/abo-images-small/images/small\"\n\nexport ASTRA_USER='ASTRA_CLIENTID'\nexport ASTRA_PASSWORD='ASTRA_CLIENTSECRET'\nexport SECURE_CONNECT_BUNDLE='SCB ZIP FILE PATH'\nexport KEYSPACE='KEYSPACE'\nexport TABLE_NAME='TABLE_NAME'\n```\n\n----\nThis code uses [Inception model](https://tfhub.dev/google/imagenet/inception_v3/feature_vector/5) to get feature vector for Images.\n\nVector size: 2048\n\n----\n\n\n```\npython3 process.py\n```\n\n---\n[Optional] This might run long, depending on your machine and network speed, it needs to load >100k images. You might want to parallelize this or split the items.csv to smaller chunks and run from multiple machines. Optimizing this is a exercise to the reader\n\nIt took me about an hour to load all image embeddings, with 3 nodes.\n\n---\n\n## Similarity Search API\n\nAPI Spec\n\nRequest\n\n```\nPOST /upload\nContent-type: application/json\n\n{\"photoData\":\"data:image/jpeg;base64,xxxxx...\"}\n```\n\nResponse: Similar Images\n```\n[\n    {\n        \"image_id\": \"https://storage.googleapis.com/demo-product-images/35/35952a54.jpg\",\n        \"item_id\": \"B07RC7R3TC\",\n        \"item_name\": \"xxx\"\n    },\n    {\n        \"image_id\": \"https://storage.googleapis.com/demo-product-images/5a/5a735214.jpg\",\n        \"item_id\": \"B081HN8L6R\",\n        \"item_name\": 'XXX\"\n    },\n    {\n        \"image_id\": \"https://storage.googleapis.com/demo-product-images/24/2435b28d.jpg\",\n        \"item_id\": \"B07T7KPCM1\",\n        \"item_name\": \"Amazon Brand - Solimo Designer Birds 3D Printed Hard Back Case Mobile Cover for LG K7\"\n    },\n    {\n        \"image_id\": \"https://storage.googleapis.com/demo-product-images/2e/2e271e7c.jpg\",\n        \"item_id\": \"B081HMTVLV\",\n        \"item_name\": \"XXX\"\n    },\n    {\n        \"image_id\": \"https://storage.googleapis.com/demo-product-images/cf/cf9f5a3a.jpg\",\n        \"item_id\": \"B07Z497KW2\",\n        \"ite",
    "_id": "mukundha-image-similarity-vector-search"
}